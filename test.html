<!DOCTYPE html>
<html style="width:100%;height:100%">
<head lang="en">
    <meta charset="UTF-8">
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
    <meta name="viewport"   content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <script type="text/javascript" src="http://webapi.amap.com/maps?v=1.3&key=76b61c311cd340081bc9379b96f547d6&plugin=AMap.LineSearch"></script>
    <title></title>
    <style type="text/css">
        html {
            font-size: 62.5%;
        }
        /*@media only screen and (max-width: 768px) {
            html {
                font-size: 1%;
            }
        }*/
        body {
            width:100%;
            height:100%;
            margin: 0;
        }
        .wresize {
            cursor: w-resize !important;
        }
        .sresize {
            cursor: s-resize !important;
        }
        .seresize {
            cursor: se-resize !important;
        }
        .swresize {
            cursor: sw-resize !important;
        }
        .rtb_point {
            position: relative;
            min-width: 20rem;
            max-width: 24rem;
            box-shadow: 0 0 0.5px rgba(0,0,100,.6);
            background: #fff;
            margin-bottom: 31px;
            border-radius: 2px;
            text-align: left;
            border: 1px solid silver;
        }
        .rtb_point_info {
            padding: 0;
            position: relative;
            background-color: #fff;
            margin: 0.8rem;
        }
        .rtb_point_info_title {
            line-height: 2.2rem;
            font-size: 1.4rem;
            border-bottom: 1px #99adce solid;
            padding-right: 1.5rem;
        }
        .rtb_point_info_content {
            padding-top: 0.5rem;
            overflow: hidden;
            font-size: 1.2rem;
            zoom: 1;
        }
        .rtb_point_close {
            position: absolute;
            right: 0.3rem;
            top: 0.3rem;
            line-height: 1.5rem;
            font-size: 1.4rem;
            color: #cfcfcf;
            cursor: pointer;
            padding: 0 0.3rem;
        }
        .rtb_point_sharp {
            position: absolute;
            bottom: -0.2rem;
            background-color: #ffffff;
            left: 50%;
            border-left: 1px solid silver;
            border-bottom: 1px solid silver;
            padding: 0.4rem;
            transform: rotate(-45deg) translateX(-50%);
        }
        .rtb_point_stop {
            position: absolute;
            width: 1.2rem;
            height: 1.2rem;
            background: url('./img/way_btn2.png') no-repeat -12px -139px;
            cursor: pointer;
        }
        .rtb_point_busLine {
            background-color: transparent;
            color: #0f89f5;
            text-decoration: none;
            cursor: pointer;
            margin: 0 2px;
        }
        .rtb_marker_info {
            padding: 0.7rem 1rem;
            line-height: 1.5rem;
            position: relative;
            background-color: #fff;
            margin-bottom: 0.8rem;
            min-width: 20rem;
            max-width: 24rem;
            box-shadow: 0 0 0.5px rgba(0,0,100,.6);
            border-radius: 2px;
            text-align: left;
            border: 1px solid silver;
        }
        .rtb_marker_sharp {
            position: absolute;
            bottom: 0.8rem;
            background-color: #ffffff;
            left: 50%;
            border-left: 1px solid silver;
            border-bottom: 1px solid silver;
            padding: 0.4rem;
            transform: rotate(-45deg) translateX(-50%);
        }
        .rtb_highlight {
            color: #0f89f5;
            font-size: 1.2rem;
        }
        .amap-marker-label{
            color: #fff;
            border: none;
            cursor: pointer;
            background-color: transparent
        }
    </style>
</head>
<body>
<div id="container" style="width:100%;height:100%"></div>
<div id="pinel"></div>
<div id="tip"></div>
<script type="text/javascript">
    let busStations = [];//保存附近公交站点
    let busName = null; //公交名
    let stopIfo = null; //站点信息
    let busline = null; //保存当前所在公交路线
    let busLineId = null; //保存当前公交id
    let busDirection = null; //当前公交方向
    let busLines = {}; //保存公交线路信息
    let last_rtb_point = null; //记录上一次点击显示的站点窗口
    let linesearch = null;//公交线路查询服务
    let lastBusData = []; //上一次获取的实时公交数据
    let lastGetTime = []; //上一次获取的实时公交时间
    let linesearchInfo = {}; //公交线路查询结果
    let nearStops = {}; //周边公交站点相关组件
    let stopid = null; //第几站点
    let stopWindow = new AMap.InfoWindow({
        isCustom: true
    }); //公交站点信息窗口
    let infoWindow = new AMap.InfoWindow({
        isCustom: true
    });//实时到站信息窗口
    let dirctionReady = false; //是否确定公交方向
    let container = document.getElementById('container');

    //公交站点信息窗口DOM-start
    let content = document.createElement('div');
    content.className = 'rtb_point ';
    content.innerHTML = `<div class="rtb_point_info">
            <div class="rtb_point_info_title"></div>
            <div class="rtb_point_info_content"></div>
            </div>`;
    let content_title = content.getElementsByClassName('rtb_point_info_title')[0];
    let content_content = content.getElementsByClassName('rtb_point_info_content')[0];

    let rtb_point_close = document.createElement('div');//关闭窗口按钮
    rtb_point_close.className = 'rtb_point_close';
    rtb_point_close.innerHTML = 'x';
    rtb_point_close.addEventListener('click', function() {
        stopWindow.close();
    });

    content.appendChild(rtb_point_close);
    let sharp = document.createElement('span');
    sharp.className = 'rtb_point_sharp';
    content.appendChild(sharp);
    //公交站点信息窗口DOM-end

    //公交线路点击事件，搜索公交线路
    content.addEventListener('click', function(e) {
        if(e.target && e.target.className.includes('rtb_point_busLine')) {
            hideBusStation(); //隐藏周边组件
            lineSearch(e.target.title, stopInfo.name.match(/[^(]*/)[0]); //公交线路查询
        }
    });

    //工具函数start
    function isJSON(obj){
        var isjson = typeof(obj) == "object" && Object.prototype.toString.call(obj).toLowerCase() == "[object object]" && !obj.length;
        return isjson;
    }
    function setHeader(){
        var header = {},auth = $.cookie("AUTH");
        header["x-client-id"] = "user-web";
        if(auth){
            header["authorization"] = "Bearer "+auth;
        }
        return header;
    }
    function formatParam(data){
        var arr = [];
        for(var name in data){
            arr.push(encodeURIComponent(name) + "=" + encodeURIComponent(data[name]));
        }
        return arr.join('&');
    }
    function ajax(option){
        var xhr = new XMLHttpRequest();
        if(option.type.toLowerCase()=='get'){
            if(option.data){
                xhr.open('get',option.url+'?'+formatParam(option.data),true);
            }else{
                xhr.open('get',option.url,true);
            }
            addHeader(option.header);
            xhr.send(null);
        }else if(option.type.toLowerCase()=='post'){
            xhr.open('post',option.url,true);
            addHeader(option.header);
            addHeader({"Content-Type":"application/x-www-form-urlencoded"});
            xhr.send(formatParam(option.data));
        }
        xhr.onreadystatechange = function(){
            if(xhr.readyState == 4){
                if(xhr.status == 200){
                    if(option.dataType && option.dataType.toLowerCase() == 'json'){
                        option.success && option.success(JSON.parse(xhr.response));
                    }else{
                        option.success && option.success(JSON.parse(xhr.response));
                    }
                }else{
                    option.error && option.error(xhr);
                }
                option.complete && option.complete(xhr);
            }
        };
        function addHeader(obj){
            if(obj){
                for(var name in obj){
                    xhr.setRequestHeader(name,obj[name]);
                }
            }
        }
    }
    //工具函数end

    //加载地图
    var map = new AMap.Map('container', {
        resizeEnable: true,
        //rotateEnable: true,
        zoom: 15
    });

    //定位
    let geoEventCom, geoEventErr;
    map.plugin('AMap.Geolocation', function() {
        geolocation = new AMap.Geolocation({
            enableHighAccuracy: true,//是否使用高精度定位
            timeout: 10000,//超过10秒后停止定位
            maximumAge: 0,//定位结果不缓存
            convert: true,//自动偏移坐标，偏移后的坐标为高德坐标
            showButton: true,//显示定位按钮
            buttonPosition: 'LB',//定位按钮停靠位置，左下角
            buttonOffset: new AMap.Pixel(10, 20),//定位按钮与设置的停靠位置的偏移量
            showMarker: true,//定位成功后在定位到的位置显示点标记
            showCircle: false,//定位成功后用圆圈表示定位经度范围
            panToLocation: true,//定位成功后将定位到的位置作为地图中心点
            zoomToAccuracy: false,//定位成功后调整地图视野范围使定位位置及经度范围视野内可见
            //extension: 'all'
        });
        map.addControl(geolocation);
        geolocation.getCurrentPosition();
        geoEventCom = AMap.event.addListener(geolocation, 'complete', onComplete);//返回定位信息
        geoEventErr = AMap.event.addListener(geolocation, 'error', onError);//返回定位出错信息
    });

    //定位成功
    function onComplete(info) {
        AMap.event.removeListener(geoEventCom);
        AMap.event.removeListener(geoEventErr);
        var str = ['定位成功'];
        str.push('经度:' + info.position.getLng());
        str.push('纬度:' + info.position.getLat());
        if(info.accuracy) {
            str.push('精度:' + info.accuracy + '米');
        }
        str.push('是否经过偏移:' + (info.isConverted?'是':'否'));
         //document.getElementById('tip').innerHTML = str.join('<br>');
        console.log(str.join('\n'));
        nearStops = {
            lnglat: info.position,
            circle: new AMap.Circle({
                map: map,
                zIndex: 90,
                center: info.position,
                radius: 500,
                stokeWeight: 1,
                strokeStyle: 'solid',
                strokeColor: '#1791fc',
                strokeOpacity: 0.35,
                fillColor: '#1791fc',
                fillOpacity: 0.35,
                bubble: true
            }),
            circleIn: new AMap.Circle({
                map: map,
                zIndex: 90,
                center: info.position,
                radius: 480,
                stokeWeight: 1,
                strokeStyle: 'solid',
                strokeColor: '#1791fc',
                strokeOpacity: 0,
                fillColor: '#1791fc',
                fillOpacity: 0
            }),
            pois: []
        }; //周边公交站点相关组件
        getStops({
            location: info.position.getLng() + ',' + info.position.getLat(),
            radius: 500,
            position: info.position
        }); //查询周边公交站点
        let lastGet = null; //延迟加载flag
        nearStops.circle.on('mouseover', handlieDone);
        nearStops.circle.on('mouseout', function(e) {
            let arr = container.className.split(' ');
            let newArr = [];
            for(let obj of arr) {
                if(obj != 'sresize' && obj != 'wresize' && obj != 'swresize' && obj != 'seresize') {
                    newArr.push(obj);
                }
            }
            container.className = newArr.join(' ');
        });
        nearStops.circle.on('mousedown', function(e) {
            map.setStatus({dragEnable: false});
            handlieDone(e);
            //console.log(Math.hypot(e.lnglat.lat - info.position.getLat(), e.lnglat.lng - info.position.getLng()) * map.getScale() * (map.getZoom() - 2.5));
            map.on('mousemove', handleMove);
        });
        map.on('mouseup', function() {
            map.setStatus({dragEnable: true});
            map.off('mousemove', handleMove);
        });
        function handleMove(e) {
            clearTimeout(lastGet);
            let r = nearStops.lnglat.distance(e.lnglat);
            if(r > 20 && r < 10000) {
                nearStops.circle.setRadius(r);
                nearStops.circleIn.setRadius(r - 20);
                map.setFitView();
            } else {
                return;
            }
            lastGet = setTimeout(function(){
                getStops({
                    location: nearStops.lnglat.getLng() + ',' + nearStops.lnglat.getLat(),
                    radius: Math.floor(r),
                    position: nearStops.lnglat
                })
            }, 1000);
        }
        function handlieDone(e) {
            let arr = container.className.split(' ');
            if(Math.abs((e.lnglat.lat - nearStops.lnglat.getLat())/(e.lnglat.lng - nearStops.lnglat.getLng())) > 2) {
                arr.push('sresize');
            } else if(Math.abs((e.lnglat.lat - nearStops.lnglat.getLat())/(e.lnglat.lng - nearStops.lnglat.getLng())) < 0.5) {
                arr.push('wresize');
            } else if((e.lnglat.lat - nearStops.lnglat.getLat())/(e.lnglat.lng - nearStops.lnglat.getLng()) >= 0.5) {
                arr.push('swresize');
            } else {
                arr.push('seresize');
            }
            container.className = arr.join(' ');
        }
    }

    //定位失败
    function onError(data) {
        AMap.event.removeListener(geoEventCom);
        AMap.event.removeListener(geoEventErr);
        let lastGet = null; //延迟加载flag
        //document.getElementById('tip').innerHTML = '定位失败';
        console.log('定位失败');
        map.setCenter(new AMap.LngLat(121.438408, 31.280004));
        nearStops = {
            lnglat: new AMap.LngLat(121.438408, 31.280004),
            circle: new AMap.Circle({
                map: map,
                zIndex: 90,
                center: new AMap.LngLat(121.438408, 31.280004),
                radius: 500,
                stokeWeight: 1,
                strokeStyle: 'solid',
                strokeColor: '#1791fc',
                strokeOpacity: 0.35,
                fillColor: '#1791fc',
                fillOpacity: 0.35,
                bubble: true
            }),
            circleIn: new AMap.Circle({
                map: map,
                zIndex: 90,
                center: new AMap.LngLat(121.438408, 31.280004),
                radius: 480,
                stokeWeight: 1,
                strokeStyle: 'solid',
                strokeColor: '#1791fc',
                strokeOpacity: 0,
                fillColor: '#1791fc',
                fillOpacity: 0
            }),
            pois: []
        };
        nearStops.circle.on('mouseover', handlieDone);
        nearStops.circle.on('mouseout', function(e) {
            let arr = container.className.split(' ');
            let newArr = [];
            for(let obj of arr) {
                if(obj != 'sresize' && obj != 'wresize' && obj != 'swresize' && obj != 'seresize') {
                    newArr.push(obj);
                }
            }
            container.className = newArr.join(' ');
        });
        nearStops.circle.on('mousedown', function(e) {
            map.setStatus({dragEnable: false});
            handlieDone(e);
            //console.log(Math.hypot(e.lnglat.lat - info.position.getLat(), e.lnglat.lng - info.position.getLng()) * map.getScale() * (map.getZoom() - 2.5));
            map.on('mousemove', handleMove);
        });
        map.on('mouseup', function() {
            map.setStatus({dragEnable: true});
            map.off('mousemove', handleMove);
        });
        function handleMove(e) {
            clearTimeout(lastGet);
            let r = nearStops.lnglat.distance(e.lnglat);
            if(r > 20 && r < 10000) {
                nearStops.circle.setRadius(r);
                nearStops.circleIn.setRadius(r - 20);
                map.setFitView();
            } else {
                return;
            }
            lastGet = setTimeout(function(){
                getStops({
                    location: nearStops.lnglat.getLng() + ',' + nearStops.lnglat.getLat(),
                    radius: Math.floor(r),
                    position: nearStops.lnglat
                })
            }, 1000);
        }
        function handlieDone(e) {
            let arr = container.className.split(' ');
            if(Math.abs((e.lnglat.lat - nearStops.lnglat.getLat())/(e.lnglat.lng - nearStops.lnglat.getLng())) > 2) {
                arr.push('sresize');
            } else if(Math.abs((e.lnglat.lat - nearStops.lnglat.getLat())/(e.lnglat.lng - nearStops.lnglat.getLng())) < 0.5) {
                arr.push('wresize');
            } else if((e.lnglat.lat - nearStops.lnglat.getLat())/(e.lnglat.lng - nearStops.lnglat.getLng()) >= 0.5) {
                arr.push('swresize');
            } else {
                arr.push('seresize');
            }
            container.className = arr.join(' ');
        }
        getStops({
            location: 121.438408 + ',' + 31.280004,
            radius: 500,
            position: new AMap.LngLat(121.438408, 31.280004)
        });
    }

    /*
     查询周边公交站点
     obj: {
        location: string（lng,lat）圆心,
        radius: number 半径
        position: lnglat 圆心
     }
     */
    function getStops(obj) {
        //站点点击事件弹出站点线路信息
        let _onclick = function(e) {
            let data = e.target.getExtData();
            stopInfo = data;
            var point = data.location.split(',');
            content_title.innerHTML = data.name;
            content_content.innerHTML = `途经公交车：${function(){let str = "";data.address.split(';').forEach(function(d){str += ('<a class="rtb_point_busLine" title="' + d + '">' + d + '</a>')});return str}()}`;
            //map.setCenter(new AMap.LngLat(point[0], point[1]));
            //map.setFitView(busStations.concat(nearStops.circle));
            /*let content = document.createElement('div');
            content.className = 'rtb_point ';
            content.innerHTML = `<div class="rtb_point_info">
            <div class="rtb_point_info_title">${data.name}</div>
            <div class="rtb_point_info_content">途经公交车：${function(){let str = "";data.address.split(';').forEach(function(d){str += ('<a class="rtb_point_busLine" title="' + d + '">' + d + '</a>')});return str}()}</div>
            </div>`;

            //关闭窗口按钮start
            let rtb_point_close = document.createElement('div');
            rtb_point_close.className = 'rtb_point_close';
            rtb_point_close.innerHTML = 'x';
            rtb_point_close.addEventListener('click', function() {
                stopWindow.close();
            });
            //关闭窗口按钮end

            content.appendChild(rtb_point_close);
            let sharp = document.createElement('span');
            sharp.className = 'rtb_point_sharp';
            content.appendChild(sharp);

            //公交线路点击事件，搜索公交线路
            content.addEventListener('click', function(e) {
                if(e.target && e.target.className.includes('rtb_point_busLine')) {
                    hideBusStation(); //隐藏周边组件
                    lineSearch(e.target.title, data.name.match(/[^(]*!/)[0]); //公交线路查询
                }
            });*/
            stopWindow.setContent(content);
            stopWindow.open(map, e.target.getPosition());
        };
        //获取周边公交站点
        ajax({
            type: 'get',
            url: 'https://restapi.amap.com/v3/place/around',
            data: {
                location: obj.location,
                key: '79a781fd5bc34c9c04a50d241db792c9',
                types: '150700|150701|150702|150703|150800',
                //keywords: '公交',
                city: 'shanghai',
                radius: obj.radius,
                sortrule: 'distance',
                offset: 20,
                page: 1,
                output: 'JSON'
            },
            success: function(data) {
                map.on('complete',function() {
                    let i = 0;
                    //描点
                    for(let busStation of data.pois) {
                        if(i < busStations.length) {
                            busStations[i].show();
                            busStations[i].setPosition(new AMap.LngLat(busStation.location.split(',')[0], busStation.location.split(',')[1]))
                        } else {
                            let marker = new AMap.Marker({
                                icon: "http://webapi.amap.com/theme/v1.3/markers/n/mark_b.png",
                                position: busStation.location.split(','),
                                clickable: true,
                                map: map,
                                zIndex: 100,
                                extData: busStation,
                                bubble: true,
                                label: {
                                    content: i + 1,
                                    offset: new AMap.Pixel(2, 0)
                                }
                            });
                            busStations.push(marker);
                            marker.setMap(map);
                            AMap.event.addListener(marker, 'click', _onclick);
                        }
                        i++;
                    }
                    for(;i < busStations.length; i++) {
                        busStations[i].hide();
                    }
                    _onclick({
                        target: busStations[0]
                    });
                    map.setFitView(busStations.concat(nearStops.circle, stopWindow));
                });
                //显示最近点信息窗体
                /*AMap.event.trigger(busStations[0], 'click', {
                    target: busStations[0]
                });*/
                /*busStations[0].emit('click', {
                    target: busStations[0]
                });*/
            }
        });
    }

    /*
     公交线路查询
     bus: string 公交名称
     name: string 站点名称
     */
    function lineSearch(bus, name) {
        if(linesearch === null) {
            linesearch = new AMap.LineSearch({
                city: 'shanghai',
                pageSize: 2,
                extensions: 'all'
            });
        }
        linesearch.search(bus, function(status, result) {
            if(status === 'complete' && result.info === 'OK') {
                busLines[bus] = result; //保存搜索结果
                busline = bus; //保存搜索公交名
                lineSearch_Callback(result, bus, name);
            } else {
                console.log(result);
            }
        });
    }
    /*
     公交线路查询结果处理
     data: object 公交线路查询结果
     bus: string 搜索公交名
     name string 站点名称
     */
    function lineSearch_Callback(data, bus, name) {
        dirctionReady = false; //方向是否确定
        //获取公交id
        ajax({
            url: './api/getBusBase',
            type: 'get',
            data: {
                name: busline
            },
            success: function(lineInfo) {
                busLineId = lineInfo.line_id;
                //获取公交途经站点
                ajax({
                    url: './api/getBusStop',
                    type: 'get',
                    data: {
                        name: busline,
                        lineid: lineInfo.line_id
                    },
                    //数据校正
                    success: function(lines) {
                        //let stops1 = [];
                        let checkData = function(arr) {
                            let i = 0;
                            for(let line of data.lineInfo) {
                                let stop = [];
                                let differentSD = [];
                                let differentSMY = [];
                                let s, g, l;
                                for(s = 0, l = line.via_stops.length; s < l; s++) {
                                    for(g = 0; g < lines[arr[i]].stops.length; g++) {
                                        if(line.via_stops[s].name === lines[arr[i]].stops[g].zdmc.replace('（', '(').replace('）', ')')) {
                                            if(line.via_stops[s].name === name && !dirctionReady) {
                                                dirctionReady = true;
                                                busDirection = (lines[arr[i]].direction === 'false'?0:1);
                                            }
                                            line.via_stops[s].shiID = lines[arr[i]].stops[g].id; //线路站点id
                                            stop.push(line.via_stops[s]);
                                            while (lines[arr[i]].stops[g].id !== lines[arr[i]].stops[0].id) {
                                                differentSMY.push(lines[arr[i]].stops.splice(0, 1)[0]);
                                                g--;
                                            }
                                            while(differentSMY.length && differentSD.length) {
                                                let sd = differentSD.splice(0, 1);
                                                let smy = differentSMY.splice(0, 1);
                                                sd[0].shiID = smy[0].id; //线路站点id
                                                stop.splice(-1, 0, sd[0]);
                                            }
                                            differentSMY.length = 0;
                                            differentSD.length = 0;
                                            lines[arr[i]].stops.splice(0, 1);
                                            break;
                                        }
                                    }
                                    if(g == lines[arr[i]].stops.length) {
                                        differentSD.push(line.via_stops[s]);
                                    }
                                }
                                while(differentSD.length && lines[arr[i]].stops.length) {
                                    let sd = differentSD.splice(0, 1);
                                    let smy = lines[arr[i]].stops.splice(0, 1);
                                    sd[0].shiID = smy[0].id; //线路站点id
                                    stop.push(sd[0]);
                                }
                                /*for(let s of line.via_stops) {
                                    for (let l of lines[arr[i]].stops) {
                                        if (s.name === l.zdmc) {
                                            if(s.name === name && !dirctionReady) {
                                                dirctionReady = true;
                                                busDirection = (lines[arr[i]].direction === 'false'?0:1);
                                            }
                                            s.shiID = l.id; //线路站点id
                                            stop.push(s);
                                            while (l.id !== lines[arr[i]].stops[0].id) {
                                                different.push({
                                                    smy: lines[arr[i]].stops.splice(0, 1),

                                                });
                                            }
                                            break;
                                        }
                                    }
                                }*/
                                busLines[bus].lineInfo[i].via_stops = stop; //保存校正后的数据
                                i++;
                            }
                        };
                        //checkData(['lineResults1', 'lineResults0']);
                        if(data.lineInfo[0].via_stops[0].name === lines['lineResults1'].stops[0].zdmc.replace('（', '(').replace('）', ')')) {
                            //checkData(['lineResults1', 'lineResults0']);
                        } else {
                            data.lineInfo = data.lineInfo.reverse();
                            //checkData(['lineResults0', 'lineResults1']);
                        }
                        checkData(['lineResults1', 'lineResults0']);
                        /*for(let s of data.lineInfo[0].via_stops) {
                            for (let l of lines['lineResults1'].stops) {
                                if (s.name === l.zdmc) {
                                    if(s.name === name) {
                                        dirctionReady = true;
                                        busDirection = 0;
                                    }
                                    s.shiID = l.id; //线路站点id
                                    stops1.push(s);
                                    while (l.id !== lines['lineResults1'].stops[0].id) {
                                        lines['lineResults1'].stops.splice(0, 1);
                                    }
                                    break;
                                }
                            }
                        }
                        let stops2 = [];
                        for(let s of data.lineInfo[1].via_stops) {
                            for (let l of lines['lineResults0'].stops) {
                                if (s.name === l.zdmc) {
                                    if(!dirctionReady && s.name === name) {
                                        dirctionReady = true;
                                        busDirection = 1;
                                    }
                                    s.shiID = l.id; //线路站点id
                                    stops2.push(s);
                                    while (l.id !== lines['lineResults0'].stops[0].id) {
                                        lines['lineResults0'].stops.splice(0, 1);
                                    }
                                    break;
                                }
                            }
                        }
                        busLines[bus].lineInfo[0].via_stops = stops2; //保存校正后的数据*/
                        if(busDirection === null) {
                            busDirection = 0;
                            name = '';
                        }
                        var lineArr = data.lineInfo;
                        var lineNum = lineArr.length;
                        if(lineNum == 0) {
                        } else {
                            var pathArr = lineArr[busDirection].path;
                            let stops = lineArr[busDirection].via_stops;
                            var startPot = stops[0].location;
                            var endPot = stops[stops.length - 1].location;
                            busName = lineArr[busDirection].name;
                            drawbusLine(startPot, endPot, pathArr, stops, name);
                        }
                    }
                });
            }
        });
    }
    /*
    实时公交绘图
     startPot: object 起点
     endPot: object 终点
     BusArr: array 路径数组
     stops: array 途经站点
     stopName: string 站点名
     */
    function drawbusLine(startPot, endPot, BusArr, stops, stopName) {
        //实时公交站点点击事件
        let _onclick = function(e) {
            let expire = 100000;
            stopid = e.target.getExtData().stopid;
            if (lastGetTime[stopid]) {
                expire = new Date() * 1 - lastGetTime[stopid];
            }
            if (expire < 10000) {
                updateRealBus(lastBusData[stopid], expire, e.target, busName);
            } else {
                let isDirectionReady = setInterval(function () {
                    if (dirctionReady) {
                        clearInterval(isDirectionReady);
                        ajax({
                            url: './api/getArriveBase',
                            type: 'get',
                            data: {
                                name: busline,
                                lineid: busLineId,
                                direction: busDirection,
                                stopid: stopid
                            },
                            success: function (data) {
                                lastGetTime[stopid] = new Date() * 1;
                                updateRealBus(data, 0, e.target, busName);
                                lastBusData[stopid] = data;
                            }
                        });
                    }
                }, 50);
            }
        };

        //起点
        if(linesearchInfo.start) {
            linesearchInfo.start.setPosition(new AMap.LngLat(startPot.lng, startPot.lat))
        } else {
            linesearchInfo.start = new AMap.Marker({
                map: map,
                position: [startPot.lng, startPot.lat],
                icon: new AMap.Icon({
                    size: new AMap.Size(40, 50),  //图标大小
                    image: "./img/start.png"
                }),
                zIndex: 200,
                extData: {
                    stopid: 1,
                    info: stops[0]
                }
            });
            linesearchInfo.start.on('click', _onclick);
        }

        //终点
        if(linesearchInfo.end) {
            linesearchInfo.end.setPosition(new AMap.LngLat(endPot.lng, endPot.lat));
            linesearchInfo.end.setExtData({
                stopid: stops.length,
                info: stops[stops.length - 1]
            })
        } else {
            linesearchInfo.end = new AMap.Marker({
                map: map,
                position: [endPot.lng, endPot.lat],
                icon: new AMap.Icon({
                    size: new AMap.Size(40, 50),  //图标大小
                    image: "./img/end.png"
                }),
                zIndex: 200,
                extData: {
                    stopid: stops.length,
                    info: stops[stops.length - 1]

                }
            });
            linesearchInfo.end.on('click', _onclick);
        }

        //线路
        linesearchInfo.busPolyline?linesearchInfo.busPolyline.setPath(BusArr):linesearchInfo.busPolyline = new AMap.Polyline({
            map: map,
            path:BusArr,
            strokeColoe: '#09f',
            strokeOpacity: 0.8,
            strokeWeight:6
        });
        //map.setFitView(); //地图自适应

        //途经站点
        if(linesearchInfo.stops) {
            if(linesearchInfo.stops.length > stops.length - 2) {
                setLinePosition(stops.length - 2, 0, stops);
            } else {
                setLinePosition(linesearchInfo.stops.length, stops.length - 2 - linesearchInfo.stops.length, stops);
            }
        } else {
            setLinePosition(0, stops.length - 2, stops);
        }

        //更新实时公交数据
        let updateRealBus = function(data, expire, marker) {
            let info = document.createElement('div');
            let infoContent = document.createElement('div');
            infoContent.className = 'rtb_marker_info';
            if(data.cars.length) {
                infoContent.innerHTML = `<span class="rtb_highlight">${busName}</span> ·
                            <span class="rtb_highlight">${data.cars[0].stopdis}</span> 站后到达·
                            <span class="rtb_highlight">${marker.getExtData().info.name}</span> ·约
                            <span class="rtb_highlight">${Math.floor((data.cars[0].time > expire / 1000?data.cars[0].time - expire / 1000:0) / 60)}</span> 分钟·车牌号
                            <span class="rtb_highlight">${data.cars[0].terminal}</span>
                        `;
            } else {
                infoContent.innerHTML = `<span class="rtb_highlight">${busName}</span> ·
                            <span class="rtb_highlight">${marker.getExtData().info.name}</span>
                            <span class="rtb_highlight">暂无数据</span>
                        `;
            }
            let infoSharp = document.createElement('span');
            infoSharp.className = 'rtb_marker_sharp';
            let infoClose = document.createElement('span');
            infoClose.className = 'rtb_point_close';
            infoClose.innerHTML = 'x';
            infoClose.addEventListener('click', function() {
                infoWindow.close();
            });
            info.appendChild(infoContent);
            info.appendChild(infoSharp);
            info.appendChild(infoClose);
            infoWindow.setContent(info);
            infoWindow.open(map, marker.getPosition());
        };
        function setLinePosition(old, n, stops) {
            if(linesearchInfo.stops === undefined) {
                linesearchInfo.stops = [];
            }
            let i = 1;
            for(let stop of linesearchInfo.stops) {
                if(i < old) {
                    stop.show();
                    stop.setPosition(new AMap.LngLat(stops[i].location.lng, stops[i].location.lat));
                    stop.setExtData({
                        stopid: stops[i].shiID,
                        info: stops[i]
                    })
                } else {
                    stop.hide();
                }
                i++;
            }
            while(n--) {
                let marker = new AMap.Marker({
                    map: map,
                    position: [stops[old + n + 1].location.lng, stops[old + n + 1].location.lat],
                    content: '<div class="rtb_point_stop"></div>',
                    zIndex: 150,
                    offset: new AMap.Pixel(-6, -6),
                    extData: {
                        stopid: stops[old + n + 1].shiID,
                        info: stops[old + n + 1]
                    }
                });
                marker.on('click', _onclick);
                linesearchInfo.stops.push(marker);
            }
        }

        if(linesearchInfo.start.getExtData().info.name === stopName) {
            linesearchInfo.start.emit('click', {
                target: linesearchInfo.start
            })
        } else if(linesearchInfo.end.getExtData().info.name === stopName) {
            linesearchInfo.end.emit('click', {
                target: linesearchInfo.end
            })
        } else {
            for(let s of linesearchInfo.stops) {
                if(s.getExtData().info.name === stopName) {
                    s.emit('click', {
                        target: s
                    })
                }
            }
        }
    }
    function switchBusDirection() {
        busDirection  = (busDirection == 1?0:1);
        infoWindow.close();
        var lineArr = busLines[busline].lineInfo;
        var lineNum = busLines[busline].lineInfo.length;
        if(lineNum == 0) {
        } else {
            var pathArr = lineArr[busDirection].path;
            var stops = lineArr[busDirection].via_stops;
            var startPot = stops[0].location;
            var endPot = stops[stops.length - 1].location;
            busName =  lineArr[busDirection].name;
            drawbusLine(startPot, endPot, pathArr, stops, linesearchInfo);
        }
    }
    //公交线路查询end

    //隐藏附近公交站点
    function hideBusStation() {
        busStations.forEach(function(s) {s.hide();});
        nearStops.circle.hide();
        nearStops.circleIn.hide();
        stopWindow.close();
    }
    //显示附近公交站点
    function showBusStation() {
        busStations.forEach(function(s) {s.show();});
        nearStops.circle.show();
        nearStops.circleIn.show();
        stopWindow.open(map, busStations[0].getPosition());
    }
</script>
</body>
</html>